/*
 * eTechRacing.c
 *
 *  Created on: Feb 15, 2024
 *      Author: Bernat
 */
//Includes
#include "main.h"
#include "stdlib.h"
#include "eTechRacing.h"
#include "LTC6811-1_eTechRacing.h"



//Functions

/* Function: delay_us
 * Purpose: Generate a delay in microseconds
 * Inputs: The amount of microseconds of the loop, the timer which has to be used
 */
void delay_us (long int us)
{
	long int delay = us * (HAL_RCC_GetHCLKFreq() / 840000);

	for(long int i = 0; i < delay; i += 18){
		__ASM("NOP");
	}
}

uint16_t Min_Volt(uint16_t *voltatjes){
	uint16_t minimum_volt = 40000;
	for(int i = 0; i < TOTAL_IC; i++){
		for(int j = 0; j < 12; j++){
			if((((j!=5) && (j!=11)) && ((i==0) ||(i==2) ||(i==3) ||(i==5) ||(i==6) ||(i==8) ||(i==9) ||(i==11) ||(i==12) ||(i==14))) || (((j!=4) && (j!=5) && (j!=10) && (j!=11)) && ((i==1) ||(i==4) ||(i==7) ||(i==10) ||(i==13)))){
				if((voltatjes[12*i+j] <= minimum_volt)){
					minimum_volt = voltatjes[12*i+j];
				}
			}
		}
	  }
	return minimum_volt;
}


uint16_t Max_Volt(uint16_t *voltatjes){
	uint16_t maximum_volt = 0;
	for(int i = 0; i < TOTAL_IC; i++){
		for(int j = 0; j < 12; j++){
			if((((j!=5) && (j!=11)) && ((i==0) ||(i==2) ||(i==3) ||(i==5) ||(i==6) ||(i==8) ||(i==9) ||(i==11) ||(i==12) ||(i==14))) || (((j!=4) && (j!=5) && (j!=10) && (j!=11)) && ((i==1) ||(i==4) ||(i==7) ||(i==10) ||(i==13)))){
				if((voltatjes[12*i+j] >= maximum_volt)){
					maximum_volt = voltatjes[12*i+j];
				}
			}
		}
	  }
	return maximum_volt;
}

float Mean_Volt(uint16_t *voltatjes){
	float mean_volt = 0;
	uint8_t volt_length = 12*TOTAL_IC;
	for(int i = 0; i<volt_length; i++){
		mean_volt = mean_volt + voltatjes[i];
		}
	mean_volt = mean_volt/volt_length;
	return mean_volt;
	}

uint32_t Sum_Volt(uint16_t *voltatjes){
	uint32_t sum_volt = 0;
		uint8_t volt_length = 12*TOTAL_IC;
		for(int i = 0; i<volt_length; i++){
			sum_volt = sum_volt + voltatjes[i];
		}
		return sum_volt;
}

uint16_t Min_Temp(uint16_t *temperatures){
	uint16_t minimum_temp = temperatures[0];
	uint8_t temp_length = 8*TOTAL_IC;
	for(int i = 0; i<temp_length; i++){
		if(temperatures[i] <= minimum_temp){
			minimum_temp = temperatures[i];
		}
	}
	return minimum_temp;
}

uint16_t Max_Temp(uint16_t *temperatures){
	uint16_t maximum_temp = 0;
	uint8_t temp_length = 8*TOTAL_IC;
	for(int i = 0; i<temp_length; i++){
		if(temperatures[i] >= maximum_temp){
			maximum_temp = temperatures[i];
		}
	}
	return maximum_temp;
}

float Mean_Temp(uint16_t *temperatures){
	uint16_t mean_temp = 0;
	uint8_t temp_length = 8*TOTAL_IC;
	for(int i = 0; i<temp_length; i++){
		mean_temp = mean_temp + temperatures[i];
		}
	mean_temp = mean_temp/temp_length;
	return mean_temp;
	}



void Conv_Temp(uint16_t *temperatures, uint16_t *temperatures_conv){
	const uint16_t Temp_table[901]={0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900};
	const uint16_t Lec[901]={22950, 22923, 22895, 22868, 22840, 22812, 22784, 22757, 22729, 22701, 22673, 22645, 22617, 22589, 22560, 22532, 22504, 22475, 22447, 22419, 22390, 22361, 22333, 22304, 22275, 22247, 22218, 22189, 22160, 22131, 22102, 22073, 22044, 22014, 21985, 21956, 21927, 21897, 21868, 21838, 21809, 21779, 21750, 21720, 21690, 21660, 21630, 21601, 21571, 21541, 21511, 21481, 21451, 21420, 21390, 21360, 21330, 21299, 21269, 21239, 21208, 21178, 21147, 21116, 21086, 21055, 21024, 20994, 20963, 20932, 20901, 20870, 20839, 20808, 20777, 20746, 20715, 20684, 20653, 20621, 20590, 20559, 20527, 20496, 20465, 20433, 20402, 20370, 20339, 20307, 20275, 20244, 20212, 20180, 20149, 20117, 20085, 20053, 20021, 19989, 19957, 19925, 19893, 19861, 19829, 19797, 19765, 19733, 19700, 19668, 19636, 19604, 19571, 19539, 19507, 19474, 19442, 19409, 19377, 19344, 19312, 19279, 19247, 19214, 19181, 19149, 19116, 19083, 19051, 19018, 18985, 18952, 18920, 18887, 18854, 18821, 18788, 18755, 18722, 18690, 18657, 18624, 18591, 18558, 18525, 18492, 18459, 18425, 18392, 18359, 18326, 18293, 18260, 18227, 18194, 18160, 18127, 18094, 18061, 18028, 17994, 17961, 17928, 17894, 17861, 17828, 17795, 17761, 17728, 17695, 17661, 17628, 17595, 17561, 17528, 17495, 17461, 17428, 17394, 17361, 17328, 17294, 17261, 17227, 17194, 17161, 17127, 17094, 17060, 17027, 16994, 16960, 16927, 16893, 16860, 16826, 16793, 16760, 16726, 16693, 16659, 16626, 16593, 16559, 16526, 16492, 16459, 16426, 16392, 16359, 16326, 16292, 16259, 16226, 16192, 16159, 16126, 16092, 16059, 16026, 15992, 15959, 15926, 15893, 15859, 15826, 15793, 15760, 15727, 15693, 15660, 15627, 15594, 15561, 15528, 15495, 15461, 15428, 15395, 15362, 15329, 15296, 15263, 15230, 15197, 15164, 15132, 15099, 15066, 15033, 15000, 14967, 14934, 14902, 14869, 14836, 14803, 14771, 14738, 14705, 14673, 14640, 14607, 14575, 14542, 14510, 14477, 14445, 14412, 14380, 14347, 14315, 14283, 14250, 14218, 14186, 14153, 14121, 14089, 14057, 14025, 13993, 13961, 13928, 13896, 13864, 13832, 13800, 13769, 13737, 13705, 13673, 13641, 13609, 13578, 13546, 13514, 13483, 13451, 13419, 13388, 13356, 13325, 13293, 13262, 13231, 13199, 13168, 13137, 13105, 13074, 13043, 13012, 12981, 12950, 12919, 12888, 12857, 12826, 12795, 12764, 12733, 12702, 12672, 12641, 12610, 12580, 12549, 12518, 12488, 12457, 12427, 12397, 12366, 12336, 12306, 12275, 12245, 12215, 12185, 12155, 12125, 12095, 12065, 12035, 12005, 11975, 11945, 11916, 11886, 11856, 11827, 11797, 11768, 11738, 11709, 11679, 11650, 11621, 11591, 11562, 11533, 11504, 11475, 11446, 11417, 11388, 11359, 11330, 11301, 11272, 11243, 11215, 11186, 11158, 11129, 11100, 11072, 11044, 11015, 10987, 10959, 10930, 10902, 10874, 10846, 10818, 10790, 10762, 10734, 10706, 10678, 10651, 10623, 10595, 10568, 10540, 10513, 10485, 10458, 10430, 10403, 10376, 10349, 10321, 10294, 10267, 10240, 10213, 10186, 10159, 10133, 10106, 10079, 10052, 10026, 9999, 9973, 9946, 9920, 9893, 9867, 9841, 9815, 9788, 9762, 9736, 9710, 9684, 9658, 9632, 9607, 9581, 9555, 9529, 9504, 9478, 9453, 9427, 9402, 9376, 9351, 9326, 9301, 9276, 9250, 9225, 9200, 9175, 9151, 9126, 9101, 9076, 9051, 9027, 9002, 8978, 8953, 8929, 8904, 8880, 8856, 8832, 8807, 8783, 8759, 8735, 8711, 8687, 8663, 8640, 8616, 8592, 8569, 8545, 8521, 8498, 8474, 8451, 8428, 8404, 8381, 8358, 8335, 8312, 8289, 8266, 8243, 8220, 8197, 8174, 8152, 8129, 8107, 8084, 8061, 8039, 8017, 7994, 7972, 7950, 7928, 7905, 7883, 7861, 7839, 7817, 7795, 7774, 7752, 7730, 7708, 7687, 7665, 7644, 7622, 7601, 7579, 7558, 7537, 7516, 7495, 7473, 7452, 7431, 7410, 7389, 7369, 7348, 7327, 7306, 7286, 7265, 7245, 7224, 7204, 7183, 7163, 7143, 7122, 7102, 7082, 7062, 7042, 7022, 7002, 6982, 6962, 6942, 6923, 6903, 6883, 6864, 6844, 6825, 6805, 6786, 6767, 6747, 6728, 6709, 6690, 6671, 6651, 6632, 6614, 6595, 6576, 6557, 6538, 6520, 6501, 6482, 6464, 6445, 6427, 6408, 6390, 6372, 6353, 6335, 6317, 6299, 6281, 6263, 6245, 6227, 6209, 6191, 6173, 6156, 6138, 6120, 6103, 6085, 6068, 6050, 6033, 6015, 5998, 5981, 5963, 5946, 5929, 5912, 5895, 5878, 5861, 5844, 5827, 5810, 5794, 5777, 5760, 5744, 5727, 5711, 5694, 5678, 5661, 5645, 5629, 5612, 5596, 5580, 5564, 5548, 5532, 5516, 5500, 5484, 5468, 5452, 5436, 5421, 5405, 5389, 5374, 5358, 5343, 5327, 5312, 5296, 5281, 5266, 5250, 5235, 5220, 5205, 5190, 5175, 5160, 5145, 5130, 5115, 5100, 5085, 5071, 5056, 5041, 5027, 5012, 4997, 4983, 4968, 4954, 4940, 4925, 4911, 4897, 4883, 4868, 4854, 4840, 4826, 4812, 4798, 4784, 4770, 4756, 4743, 4729, 4715, 4701, 4688, 4674, 4661, 4647, 4634, 4620, 4607, 4593, 4580, 4567, 4553, 4540, 4527, 4514, 4501, 4488, 4475, 4462, 4449, 4436, 4423, 4410, 4397, 4385, 4372, 4359, 4346, 4334, 4321, 4309, 4296, 4284, 4271, 4259, 4247, 4234, 4222, 4210, 4197, 4185, 4173, 4161, 4149, 4137, 4125, 4113, 4101, 4089, 4077, 4065, 4054, 4042, 4030, 4018, 4007, 3995, 3984, 3972, 3961, 3949, 3938, 3926, 3915, 3903, 3892, 3881, 3870, 3858, 3847, 3836, 3825, 3814, 3803, 3792, 3781, 3770, 3759, 3748, 3737, 3727, 3716, 3705, 3694, 3684, 3673, 3662, 3652, 3641, 3631, 3620, 3610, 3599, 3589, 3578, 3568, 3558, 3548, 3537, 3527, 3517, 3507, 3497, 3487, 3477, 3466, 3456, 3447, 3437, 3427, 3417, 3407, 3397, 3387, 3378, 3368, 3358, 3348, 3339, 3329, 3320, 3310, 3301, 3291, 3282, 3272, 3263, 3253, 3244, 3235, 3225, 3216, 3207, 3198, 3188, 3179, 3170, 3161, 3152, 3143, 3134, 3125, 3116, 3107, 3098, 3089, 3080, 3072, 3063, 3054, 3045, 3036, 3028, 3019, 3010, 3002, 2993, 2985, 2976, 2968, 2959, 2951, 2942, 2934, 2925, 2917, 2909, 2900, 2892, 2884, 2876, 2868, 2859, 2851, 2843, 2835, 2827, 2819, 2811, 2803, 2795, 2787, 2779, 2771, 2763, 2755, 2747, 2740, 2732, 2724, 2716, 2709, 2701, 2693, 2686, 2678, 2670, 2663, 2655, 2648, 2640, 2633, 2625, 2618, 2610, 2603, 2596, 2588, 2581, 2574, 2566, 2559, 2552, 2545, 2537, 2530, 2523, 2516};

	   for(int a=0;a<8*TOTAL_IC;a++){
	   	      	int i = 0;
	   			while (i < 900 && temperatures[a] < Lec[i + 1]) {
	   				i++;
	   			}
	   			temperatures_conv[a]=Temp_table[i];
	   			if(temperatures_conv[a] == 866){
	   				temperatures_conv[a] = 0;
	   			}
	   	}
}
int32_t Curr_EVAL(uint8_t *current_arr) {
    int32_t current;
    current = (current_arr[3] + (current_arr[2] << 8)+ (current_arr[1] << 16)+ ((current_arr[0]^0X80)<< 24));
    return current;
}


